# 多用户并发访问说明

## 概述
本系统已升级支持多用户并发访问，通过以下技术手段确保数据一致性和用户体验：

## 主要改进

### 1. 数据库层面
- **WAL模式**：启用SQLite的WAL（Write-Ahead Logging）模式，提高并发性能
- **连接超时**：设置10秒连接超时，避免长时间等待
- **重试机制**：自动重试最多3次，递增延迟策略
- **事务支持**：关键操作使用事务确保原子性

### 2. 乐观锁机制
- **版本控制**：使用`updated_at`字段作为版本号
- **冲突检测**：编辑前检查数据版本，防止覆盖他人修改
- **智能重试**：检测到冲突时提供刷新重试选项

### 3. 用户界面改进
- **处理中提示**：长时间操作显示进度条
- **状态栏**：实时显示系统状态和数据库连接状态
- **详细确认**：重要操作提供详细说明
- **错误处理**：友好的错误提示和解决建议

## 使用建议

### 多用户协作最佳实践
1. **编辑物料时**：
   - 系统会自动检测数据冲突
   - 如遇冲突，选择"刷新后重试"即可获得最新数据
   - 建议编辑前先刷新数据

2. **完成订单时**：
   - 系统会预先检查库存是否充足
   - 使用事务确保订单状态和库存更新的原子性
   - 操作不可撤销，请谨慎确认

3. **状态监控**：
   - 关注状态栏的数据库连接状态
   - 绿色表示正常，红色表示异常
   - 系统每5秒自动检查连接状态

### 性能优化
- **WAL模式**：支持多读单写，提高并发性能
- **连接池**：每个操作使用独立连接，避免阻塞
- **缓存优化**：增加SQLite缓存大小到10000页

## 技术细节

### 数据库配置
```sql
PRAGMA journal_mode=WAL;      -- 启用WAL模式
PRAGMA synchronous=NORMAL;    -- 平衡性能和安全
PRAGMA cache_size=10000;      -- 增加缓存
```

### 乐观锁实现
```python
# 获取带版本的数据
material_data = db.get_material_with_version(material_id)

# 使用版本号更新
success = db.update_material_with_version(
    material_id, data, expected_version
)
```

### 事务处理
```python
# 原子性操作
operations = [
    ("UPDATE orders SET status=?", (status, order_id)),
    ("UPDATE materials SET quantity=?", (new_qty, material_id)),
    ("INSERT INTO stock_movements ...", (movement_data,))
]
db.execute_transaction(operations)
```

## 故障排除

### 常见问题
1. **"数据库被锁定"**：
   - 系统会自动重试，请稍等
   - 如持续出现，检查是否有其他程序占用数据库

2. **"数据已被其他用户修改"**：
   - 这是正常的并发保护机制
   - 选择"刷新后重试"即可

3. **"库存不足"**：
   - 检查当前库存是否满足订单需求
   - 可能需要先补充库存

### 性能监控
- 状态栏显示实时连接状态
- 处理中对话框显示操作进度
- 错误信息提供具体原因和解决建议

## 版本信息
- 当前版本：v1.1
- 新增功能：多用户并发支持
- 兼容性：向后兼容v1.0数据格式
